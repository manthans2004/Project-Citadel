
<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Project Citadel - Enhanced Hill Cipher</title>
    <style>
        * {
            box-sizing: border-box;
            margin: 0;
            padding: 0;
        }
        
        body {
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            min-height: 100vh;
            padding: 20px;
            color: #333;
        }
        
        .container {
            max-width: 1200px;
            margin: 0 auto;
            background: white;
            padding: 30px;
            border-radius: 15px;
            box-shadow: 0 20px 40px rgba(0,0,0,0.1);
        }
        
        header {
            text-align: center;
            margin-bottom: 30px;
        }
        
        h1 {
            color: #2c3e50;
            font-size: 2.5em;
            margin-bottom: 10px;
        }
        
        .subtitle {
            color: #7f8c8d;
            font-size: 1.2em;
            margin-bottom: 20px;
        }
        
        .input-section {
            background: #f8f9fa;
            padding: 25px;
            border-radius: 10px;
            margin-bottom: 25px;
        }
        
        .input-group {
            margin-bottom: 20px;
        }
        
        label {
            display: block;
            margin-bottom: 8px;
            font-weight: bold;
            color: #34495e;
        }
        
        input, button {
            padding: 14px;
            border: 2px solid #ddd;
            border-radius: 8px;
            width: 100%;
            font-size: 16px;
        }
        
        input:focus {
            border-color: #3498db;
            outline: none;
        }
        
        button {
            background: #3498db;
            color: white;
            border: none;
            cursor: pointer;
            font-weight: bold;
            transition: background 0.3s;
            margin-top: 10px;
        }
        
        button:hover {
            background: #2980b9;
        }
        
        .instructions {
            background: #e8f4fc;
            padding: 20px;
            border-radius: 8px;
            margin: 20px 0;
            border-left: 4px solid #3498db;
        }
        
        .instructions h3 {
            color: #2c3e50;
            margin-bottom: 15px;
        }
        
        .instructions ol {
            padding-left: 20px;
        }
        
        .instructions li {
            margin-bottom: 10px;
            line-height: 1.5;
        }
        
        .results-container {
            display: none;
            margin-top: 30px;
        }
        
        .results-grid {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 25px;
            margin-bottom: 30px;
        }
        
        .result-box {
            background: #f8f9fa;
            padding: 20px;
            border-radius: 10px;
            border: 1px solid #e0e0e0;
        }
        
        .result-box h3 {
            color: #2c3e50;
            margin-bottom: 15px;
            padding-bottom: 10px;
            border-bottom: 2px solid #3498db;
        }
        
        .result-item {
            margin-bottom: 15px;
        }
        
        .result-item strong {
            display: block;
            margin-bottom: 5px;
            color: #34495e;
        }
        
        .result-value {
            background: white;
            padding: 12px;
            border-radius: 6px;
            font-family: 'Courier New', monospace;
            font-size: 1.1em;
            word-break: break-all;
            border: 1px solid #eee;
        }
        
        .steps-container {
            margin: 30px 0;
        }
        
        .steps-container h2 {
            color: #2c3e50;
            margin-bottom: 20px;
            padding-bottom: 10px;
            border-bottom: 2px solid #3498db;
        }
        
        .step {
            background: white;
            border: 1px solid #e0e0e0;
            border-radius: 10px;
            padding: 20px;
            margin: 20px 0;
            box-shadow: 0 4px 8px rgba(0,0,0,0.05);
        }
        
        .step-header {
            color: #3498db;
            font-weight: bold;
            margin-bottom: 15px;
            font-size: 1.2em;
        }
        
        .step-details {
            background: #f8f9fa;
            padding: 15px;
            border-radius: 8px;
            margin: 15px 0;
            line-height: 1.6;
        }
        
        .step-result {
            background: #e8f6f3;
            padding: 15px;
            border-radius: 8px;
            border-left: 4px solid #27ae60;
            font-weight: bold;
            margin-top: 15px;
        }
        
        .math {
            font-family: 'Courier New', monospace;
            background: #f0f0f0;
            padding: 3px 6px;
            border-radius: 4px;
        }
        
        .verification {
            background: #e8f6f3;
            padding: 25px;
            border-radius: 10px;
            margin-top: 30px;
            border-left: 4px solid #27ae60;
        }
        
        .verification h3 {
            color: #2c3e50;
            margin-bottom: 15px;
        }
        
        .success {
            color: #27ae60;
            font-weight: bold;
        }
        
        .error {
            color: #e74c3c;
            font-weight: bold;
        }
        
        .sbox-table {
            display: grid;
            grid-template-columns: repeat(8, 1fr);
            gap: 5px;
            margin-top: 10px;
        }
        
        .sbox-item {
            padding: 5px;
            background: #f0f0f0;
            border-radius: 3px;
            text-align: center;
            font-family: 'Courier New', monospace;
        }
        
        @media (max-width: 768px) {
            .results-grid {
                grid-template-columns: 1fr;
            }
            
            .sbox-table {
                grid-template-columns: repeat(4, 1fr);
            }
            
            .container {
                padding: 15px;
            }
            
            h1 {
                font-size: 2em;
            }
        }
    </style>
</head>
<body>
  <div class="container">
    <header>
      <h1>üîê Project Citadel</h1>
      <p class="subtitle">Enhanced Hill Cipher with S-Box & CBC Mode</p>
    </header>

    <div class="input-section">
      <h2>üîç How This Works</h2>
      <div class="instructions">
        <h3>Encryption Process Steps:</h3>
        <ol>
          <li><strong>CBC Mode:</strong> Add previous ciphertext block (or IV for first block)</li>
          <li><strong>Hill Cipher:</strong> Matrix multiplication with key matrix</li>
          <li><strong>S-Box:</strong> Non-linear substitution using S(x) = (7x + 3) mod 26</li>
          <li><strong>Decryption:</strong> Reverse all steps in opposite order</li>
        </ol>
        <h3>Key Requirements:</h3>
<ul>
  <li>Key must be an n√ón square matrix (2√ó2, 3√ó3, ‚Ä¶)</li>
  <li>Matrix must be invertible modulo 26</li>
  <li>Text should contain only letters A-Z (case insensitive)</li>
</ul>
      </div>

      <div class="input-group">
        <label for="keyInput">Key Matrix (e.g., [[3,5],[2,7]]):</label>
        <input type="text" id="keyInput" placeholder='Enter a 2x2 matrix' value='[[3,5],[2,7]]'>
      </div>

      <div class="input-group">
        <label for="textInput">Text to Encrypt (Letters A-Z only):</label>
        <input type="text" id="textInput" placeholder="Example: HELP, CRYPTO, TEST" value="HELP">
      </div>

      <button onclick="processText('encrypt')">üöÄ Encrypt & Show Steps</button>
    </div>

    <div id="resultsSection" class="results-container" style="display:none;">
      <!-- results layout identical to your previous file -->
      <!-- copy the 'results-grid', 'steps-container', 'verification' sections from previous HTML -->
      <div class="results-grid">
        <div class="result-box">
          <h3>üìä Encryption Results</h3>
          <div class="result-item">
            <strong>Original Text:</strong>
            <div id="originalText" class="result-value">-</div>
          </div>
          <div class="result-item">
            <strong>Ciphertext:</strong>
            <div id="ciphertext" class="result-value">-</div>
          </div>
          <div class="result-item">
            <strong>IV Used:</strong>
            <div id="ivValue" class="result-value">-</div>
          </div>
        </div>

        <div class="result-box">
          <h3>üîë Configuration</h3>
          <div class="result-item">
            <strong>Key Matrix:</strong>
            <div id="keyMatrix" class="result-value">-</div>
          </div>
          <div class="result-item">
            <strong>S-Box Values:</strong>
            <div id="sboxValues" class="result-value">-</div>
          </div>
        </div>
      </div>

      <div class="steps-container">
        <h2>üìù Step-by-Step Encryption Process</h2>
        <div id="encryptionSteps"></div>
      </div>

      <div class="steps-container">
        <h2>üìù Step-by-Step Decryption Process</h2>
        <div id="decryptionSteps"></div>
      </div>

      <div class="verification">
        <h3>‚úÖ Verification</h3>
        <div class="result-item">
          <strong>Decrypted Text:</strong>
          <div id="decryptedText" class="result-value">-</div>
        </div>
        <div class="result-item">
          <strong>Status:</strong>
          <div id="successStatus" class="result-value">-</div>
        </div>
      </div>
    </div>
  </div>

  <script>
    // Helper to parse key input string into array if possible
    function parseKeyInput(raw) {
      raw = raw.trim();
      if (!raw) return null;
      try {
        // allow both JSON format and python-like list format
        return JSON.parse(raw);
      } catch (e) {
        // fallback: try to eval Python-like list using small parser
        try {
          // replace single quotes with double, ensure valid JSON style
          const normalized = raw.replace(/'/g, '"');
          return JSON.parse(normalized);
        } catch (e2) {
          // last resort: return raw string (server will try ast.literal_eval)
          return raw;
        }
      }
    }

    function processText(action) {
      const text = document.getElementById('textInput').value.trim();
      const keyInputRaw = document.getElementById('keyInput').value.trim();

      if (!text) {
        alert('Please enter some text to encrypt');
        return;
      }

      const key_matrix = parseKeyInput(keyInputRaw);

      // debug
      console.log('Request', { action, text, key_matrix });

      fetch('/process', {
        method: 'POST',
        headers: { 'Content-Type': 'application/json' },
        body: JSON.stringify({ action: action, text: text, key_matrix: key_matrix })
      })
      .then(response => response.json())
      .then(data => {
        console.log('Response', data);
        if (data.success) {
          showResults(data);
        } else {
          alert('Error: ' + (data.error || 'Unknown error'));
        }
      })
      .catch(error => {
        console.error('Error:', error);
        alert('Error processing text');
      });
    }

    function showResults(data) {
      document.getElementById('resultsSection').style.display = 'block';
      document.getElementById('originalText').textContent = data.plaintext || '';
      document.getElementById('ciphertext').textContent = data.result || '';
      document.getElementById('ivValue').textContent = JSON.stringify(data.iv || []);
      document.getElementById('keyMatrix').textContent = JSON.stringify(data.key_matrix || '-');

      // Show S-Box values
      let sboxHtml = '<div class="sbox-table">';
      const sbox = data.sbox || [];
      for (let i = 0; i < sbox.length; i++) {
        sboxHtml += `<div class="sbox-item">${i}‚Üí${sbox[i]}</div>`;
        if ((i + 1) % 8 === 0 && i !== sbox.length - 1) sboxHtml += '</div><div class="sbox-table">';
      }
      sboxHtml += '</div>';
      document.getElementById('sboxValues').innerHTML = sboxHtml;

      // Encryption steps
      const encryptionSteps = document.getElementById('encryptionSteps');
      encryptionSteps.innerHTML = '';
      (data.steps || []).forEach(step => {
        const stepDiv = document.createElement('div');
        stepDiv.className = 'step';
        let detailsHtml = '';
        (step.details || []).forEach(detail => {
          detailsHtml += `<div>${detail}</div>`;
        });
        stepDiv.innerHTML = `
          <div class="step-header">${step.step}</div>
          <div class="step-details">${detailsHtml}</div>
          ${step.result ? `<div class="step-result">${step.result}</div>` : ''}
        `;
        encryptionSteps.appendChild(stepDiv);
      });

      // Decrypt to show reverse steps (send key_matrix as actual array if available)
      decryptText(data.result, data.iv, data.key_matrix);
    }

    function decryptText(ciphertext, iv, key_matrix) {
      fetch('/process', {
        method: 'POST',
        headers: { 'Content-Type': 'application/json' },
        body: JSON.stringify({
          action: 'decrypt',
          text: ciphertext,
          iv: iv,
          key_matrix: key_matrix
        })
      })
      .then(response => response.json())
      .then(data => {
        console.log('Decrypt response', data);
        if (data.success) {
          showDecryptionResults(data);
        } else {
          alert('Decryption error: ' + (data.error || 'Unknown error'));
        }
      })
      .catch(err => {
        console.error('Decrypt Error:', err);
        alert('Error during decryption request');
      });
    }

    function showDecryptionResults(data) {
      document.getElementById('decryptedText').textContent = data.result || '';

      // Normalize case and remove pad X's for comparison
      const originalTextRaw = document.getElementById('originalText').textContent || '';
      const originalText = originalTextRaw.toUpperCase().replace(/[^A-Z]/g, '');
      let decryptedText = (data.result || '').toUpperCase().replace(/[^A-Z]/g, '');
      // remove trailing padding Xs that were added during encryption
      decryptedText = decryptedText.replace(/X+$/g, '');

      const success = originalText === decryptedText;

      document.getElementById('successStatus').textContent =
        success ? '‚úÖ SUCCESS - Text encrypted and decrypted correctly!' : '‚ùå FAILED - Something went wrong';
      document.getElementById('successStatus').className = success ? 'success' : 'error';

      // Show decryption steps
      const decryptionSteps = document.getElementById('decryptionSteps');
      decryptionSteps.innerHTML = '';
      (data.steps || []).forEach(step => {
        const stepDiv = document.createElement('div');
        stepDiv.className = 'step';
        let detailsHtml = '';
        (step.details || []).forEach(detail => {
          detailsHtml += `<div>${detail}</div>`;
        });
        stepDiv.innerHTML = `
          <div class="step-header">${step.step}</div>
          <div class="step-details">${detailsHtml}</div>
          ${step.result ? `<div class="step-result">${step.result}</div>` : ''}
        `;
        decryptionSteps.appendChild(stepDiv);
      });
    }
  </script>
</body>
</html>